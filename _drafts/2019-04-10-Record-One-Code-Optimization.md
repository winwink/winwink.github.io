---
layout: post2
title: 记一次代码优化
description:
keywords: Optimization
tags: [SharePoint]
---

有一个同事写了客户端程序, 运行比较慢, 让我给他优化一下.
这个程序的目的, 是通过调用 SharePoint API 将一个文档库的文件夹和文件以及相应的权限迁移到新的文档库中.

优化前的代码, 大约是 1 分钟 3 个 case. 我先让他给我讲下代码的逻辑, 一步步分析后找到一个分支多余的代码, 这个分支只是进行了大量的查询, 没有用到相应的数据, 所以把这个这个分支去掉了, 运行了下, 大约 1 分钟 6 个 case, 还是太慢.

由于代码中耗时主要在等待 API 结果上, 而这个程序是单线程的, 所以我准备改成多线程. 接着我加了一个内存中的 Queue, 把 case 都存在这个 Queue 中, 多个线程以加锁的方式访问这个 Queue, 测试了线程数, 大概 5 个线程达到最高的效率, 此时 1 分钟 15 个 case.

接着我把复制了这个程序, 在多个地方分别运行. 由于 case 是每月按照一个文件夹分开存放的, 所以我按不同的月份独立运行多个程序. 此时 1 分钟 60 个 case. 有个缺点, 有的月份 case 多一些, 有的月份 case 少一些, 结束有先后, 到后期速度就降下来了. 而且没办法大量扩展, 只能做到按月进行增加进程.

我想了下, 这个其实算经典的生产者-消费者模型, 准备用 Redis, 多个进程同时访问 Redis, 分 3 个集合, 一个生产者将 case 查询后插入, 多个消费者共同消费这个队列. 这个可以做到无限扩展, 只取决于服务端的承受能力了.
